<ng-template #makePurchaseModal let-modal>
  <div class="modal-header bg-primary text-white">
    <h4 class="modal-title d-flex align-items-center" id="modal-basic-title">
      <i class="material-icons me-2">shopping_cart</i>
      <div>
        <div class="fw-bold">Realizar Compra</div>
        <small class="opacity-75">{{ user.name + ' ' + user.last_name }} ({{ user.user_name }})</small>
      </div>
    </h4>
    <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="modal.dismiss()"></button>
  </div>
  <form class="register-form" [formGroup]="makePurchaseForm" (ngSubmit)="addProductToList()">
    <div class="modal-body p-4">
      <!-- Daily Bonus Activation -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-info">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title mb-1 text-info">
                    <i class="material-icons me-2" style="vertical-align: middle;">card_giftcard</i>
                    Bonos Diarios
                  </h6>
                  <small class="text-muted">Activar bonos diarios para esta compra</small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="dailyBonusSwitch"
                         formControlName="dailyBonusActivation" style="transform: scale(1.2);">
                  <label class="form-check-label fw-bold text-info" for="dailyBonusSwitch">
                    {{ makePurchaseForm.get('dailyBonusActivation')?.value ? 'Activado' : 'Desactivado' }}
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monthly Settlement Inclusion -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card border-warning">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="card-title mb-1 text-warning">
                    <i class="material-icons me-2" style="vertical-align: middle;">receipt</i>
                    Liquidación Mensual
                  </h6>
                  <small class="text-muted">Incluir esta factura en la liquidación mensual</small>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="monthlySettlementSwitch"
                         formControlName="includeInCommissionCalculation" style="transform: scale(1.2);">
                  <label class="form-check-label fw-bold text-warning" for="monthlySettlementSwitch">
                    {{ makePurchaseForm.get('includeInCommissionCalculation')?.value ? 'Incluida' : 'Excluida' }}
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Selection -->
      <div class="row mb-3">
        <div class="col-md-6 mb-3">
          <label for="select-product" class="form-label fw-semibold">
            <i class="material-icons me-1" style="vertical-align: middle; font-size: 18px;">inventory</i>
            Producto <span class="text-danger">*</span>
          </label>
          <select class="form-select" formControlName="selectedProduct">
            <option value="" disabled>Seleccionar producto...</option>
            <option *ngFor="let product of productList" [value]="product.id">
              {{ product.name }} - ${{ product.salePrice }}
            </option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <label for="quantity" class="form-label fw-semibold">
            <i class="material-icons me-1" style="vertical-align: middle; font-size: 18px;">format_list_numbered</i>
            Cantidad <span class="text-danger">*</span>
          </label>
          <input type="number" class="form-control" formControlName="quantity" min="1" required/>
        </div>
      </div>
      <!-- Products List -->
      <div class="mt-4" *ngIf="products.length > 0">
        <h5 class="mb-3">
          <i class="material-icons me-2" style="vertical-align: middle;">shopping_basket</i>
          Productos agregados ({{ products.length }})
        </h5>
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Producto</th>
                        <th>Precio</th>
                        <th>Cantidad</th>
                        <th>Total</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of products">
                        <td class="fw-semibold">{{ item.name }}</td>
                        <td class="text-success">${{ item.salePrice }}</td>
                        <td><span class="badge bg-secondary">{{ item.quantity }}</span></td>
                        <td class="fw-bold text-primary">${{ item.salePrice * item.quantity }}</td>
                        <td>
                          <button type="button" class="btn btn-outline-danger btn-sm"
                                  (click)="removeProductFromList(item)" title="Eliminar producto">
                            <i class="material-icons" style="font-size: 16px;">delete</i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4" *ngIf="products.length === 0">
        <div class="text-center text-muted py-4">
          <i class="material-icons mb-2" style="font-size: 48px; opacity: 0.5;">shopping_cart</i>
          <p class="mb-0">No hay productos agregados</p>
          <small>Selecciona un producto y agrégalo a la lista</small>
        </div>
      </div>
    </div>
    <div class="modal-footer bg-light border-top">
      <div class="d-flex justify-content-between w-100">
        <div>
          <button type="submit" class="btn btn-outline-primary me-2" [disabled]="makePurchaseForm.invalid">
            <i class="material-icons me-1" style="vertical-align: middle; font-size: 18px;">add_shopping_cart</i>
            Agregar producto
          </button>
        </div>
        <div>
          <button type="button" class="btn btn-secondary me-2" (click)="modal.close('Close click')">
            <i class="material-icons me-1" style="vertical-align: middle; font-size: 18px;">close</i>
            Cancelar
          </button>
          <button type="button" class="btn btn-success" (click)="confirmPurchase(0)" [disabled]="products.length === 0">
            <i class="material-icons me-1" style="vertical-align: middle; font-size: 18px;">payment</i>
            Realizar Compra
          </button>
        </div>
      </div>
    </div>

  </form>

</ng-template>
